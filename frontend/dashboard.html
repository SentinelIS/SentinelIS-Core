<!DOCTYPE html>
<html lang="en">
<head>
    <!--Link for Remix Icons-->
    <link href="https://unpkg.com/remixicon/fonts/remixicon.css" rel="stylesheet">

    <link rel="stylesheet" href="styles/dashboard.css">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
</head>
<body>
    <nav class="topbar">
        <div class="searchbar">
            <input type="text" placeholder="Search...">
            <i class="ri-search-line"></i>
        </div>
        <ul>
            <li><a href="profile.html"><i class="ri-user-fill"></i> Profile</a></li>
            <li><a href="http://localhost:5137/"><i class="ri-message-2-fill"></i> Chat</a></li>
            <li><a href=""><i class="ri-notification-3-fill"></i> Notifications</a></li>
            <li><a href="settings.html"><i class="ri-settings-5-fill"></i> Setting</a></li>
            <li><a href="http://localhost:3000/login.html"><i class="ri-logout-box-r-fill"></i> Logout</a></li>
        </ul>
    </nav>

    <nav class="sidenav">
        <ul>
            <li><a href="#dashboard-header"><i class="ri-dashboard-fill"></i> Dashboard</a></li>
            <li><a href="#asset-management-h2"><i class="ri-folder-2-fill"></i> Asset-Management</a></li>
            <li><a href="#risk-assessment-h2"><i class="ri-shield-fill"></i> Risk Assessment</a></li>
            <li><a href="#policies-h2"><i class="ri-file-list-3-fill"></i> Policies</a></li>
            <li><a href="#compliance-audit-h2"><i class="ri-checkbox-multiple-fill"></i> Compliance & Audit</a></li>
            <li><a href="#incident-management-h2"><i class="ri-alert-fill"></i> Incident-Management</a></li>
        </ul>
    </nav>

    <main>
        <div id="dashboard-header" class="main-header">
            <h1>Welcome, <span id="username">User</span></h1>
            <button onclick="window.location.href='http://localhost:3000/adduser.html'">
                <i class="ri-user-add-fill"></i> Add user
            </button>
        </div>

        <div class="dashboard-sections">
            <div class="dashboard-section">
                <div class="dashboard-section-header">
                    <h2 id="asset-management-h2"><i class="ri-folder-2-fill"></i> Asset-Management</h2>
                    <button id="add-asset-btn"><i class="ri-add-fill"></i> Add new asset</button>
                </div>
                <div id="asset-list"></div>
            </div>
            <div class="dashboard-section">
                <div class="dashboard-section-header">
                    <h2 id="risk-assessment-h2"><i class="ri-shield-fill"></i> Risk Assessment</h2>
                    <button><i class="ri-add-fill"></i> Add new risk</button>
                </div>
            </div>
            <div class="dashboard-section">
                <div class="dashboard-section-header">
                    <h2 id="policies-h2"><i class="ri-file-list-3-fill"></i> Policies</h2>
                    <button><i class="ri-add-fill"></i> Add new policy</button>
                </div>
            </div>
            <div class="dashboard-section">
                <div class="dashboard-section-header">
                    <h2 id="compliance-audit-h2"><i class="ri-checkbox-multiple-fill"></i> Compliance & Audit</h2>
                    <button><i class="ri-add-fill"></i> Add new audit</button>
                </div>
            </div>
            <div class="dashboard-section">
                <div class="dashboard-section-header">
                    <h2 id="incident-management-h2"><i class="ri-alert-fill"></i> Incident-Management</h2>
                    <button><i class="ri-add-fill"></i> Report new incident</button>
                </div>
            </div>
        </div>
    </main>

    <div id="add-asset-modal" class="modal-overlay modal-hidden">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="ri-add-fill"></i> Add New Asset</h2>
                <button id="add-asset-modal-close" class="modal-close"><i class="ri-close-line"></i></button>
            </div>
            <div class="modal-body">
                <form id="add-asset-form">
                    <div class="field">
                        <label for="asset-name">Asset Name</label>
                        <input type="text" id="asset-name" name="asset-name" required>
                    </div>
                    <div class="field">
                        <label for="asset-type">Asset Type</label>
                        <select id="asset-type" name="asset-type" required>
                            <option value="Server">Server</option>
                            <option value="Application">Application</option>
                            <option value="Device">Device</option>
                            <option value="Database">Database</option>
                        </select>
                    </div>
                    <div class="field">
                        <label for="asset-description">Description</label>
                        <textarea id="asset-description" name="asset-description" rows="3"></textarea>
                    </div>
                    <div class="field two-col">
                        <div class="field">
                            <label for="asset-classification">Classification</label>
                            <select id="asset-classification" name="asset-classification">
                                <option value="public">Public</option>
                                <option value="internal">Internal</option>
                                <option value="top secret">Top Secret</option>
                            </select>
                        </div>
                        <div class="field">
                            <label for="asset-location">Location</label>
                            <input type="text" id="asset-location" name="asset-location">
                        </div>
                    </div>
                    <div class="field two-col">
                        <div class="field">
                            <label for="asset-owner">Owner</label>
                            <input type="text" id="asset-owner" name="asset-owner">
                        </div>
                        <div class="field">
                            <label for="asset-value">Value</label>
                            <select id="asset-value" name="asset-value">
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                                <option value="critical">Critical</option>
                            </select>
                        </div>
                    </div>
                    <div class="field">
                        <label for="asset-status">Status</label>
                         <select id="asset-status" name="asset-status">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="in planning">In Planning</option>
                            <option value="decommissioned">Decommissioned</option>
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="primary-btn">Save Asset</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="edit-asset-modal" class="modal-overlay modal-hidden">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="ri-pencil-line"></i> Edit Asset</h2>
                <button id="edit-asset-modal-close" class="modal-close"><i class="ri-close-line"></i></button>
            </div>
            <div class="modal-body">
                <form id="edit-asset-form" class="readonly-mode">
                    <input type="hidden" id="edit-asset-id" name="asset-id">
                    <div class="field">
                        <label for="edit-asset-name">Asset Name</label>
                        <input type="text" id="edit-asset-name" name="asset-name" required>
                    </div>
                    <div class="field">
                        <label for="edit-asset-type">Asset Type</label>
                        <select id="edit-asset-type" name="asset-type" required>
                            <option value="Server">Server</option>
                            <option value="Application">Application</option>
                            <option value="Device">Device</option>
                            <option value="Database">Database</option>
                        </select>
                    </div>
                    <div class="field">
                        <label for="edit-asset-description">Description</label>
                        <textarea id="edit-asset-description" name="asset-description" rows="3"></textarea>
                    </div>
                    <div class="field two-col">
                        <div class="field">
                            <label for="edit-asset-classification">Classification</label>
                            <select id="edit-asset-classification" name="asset-classification">
                                <option value="public">Public</option>
                                <option value="internal">Internal</option>
                                <option value="top secret">Top Secret</option>
                            </select>
                        </div>
                        <div class="field">
                            <label for="edit-asset-location">Location</label>
                            <input type="text" id="edit-asset-location" name="asset-location">
                        </div>
                    </div>
                    <div class="field two-col">
                        <div class="field">
                            <label for="edit-asset-owner">Owner</label>
                            <input type="text" id="edit-asset-owner" name="asset-owner">
                        </div>
                        <div class="field">
                            <label for="edit-asset-value">Value</label>
                            <select id="edit-asset-value" name="asset-value">
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                                <option value="critical">Critical</option>
                            </select>
                        </div>
                    </div>
                    <div class="field">
                        <label for="edit-asset-status">Status</label>
                         <select id="edit-asset-status" name="asset-status">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="in planning">In Planning</option>
                            <option value="decommissioned">Decommissioned</option>
                        </select>
                    </div>
                    <div class="modal-footer" id="edit-modal-footer">
                        <button type="button" id="edit-asset-btn" class="secondary-btn">Edit</button>
                        <button type="submit" id="save-asset-btn" class="primary-btn" style="display: none;">Save Changes</button>
                        <button type="button" id="delete-asset-btn" class="danger-btn">Delete Asset</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // show username saved by login-handler.js (localStorage)
        document.addEventListener('DOMContentLoaded', () => {
            const name = localStorage.getItem('username') || 'User';
            const el = document.getElementById('username');
            if (el) el.textContent = name;

            const addAssetModal = document.getElementById('add-asset-modal');
            const addAssetBtn = document.getElementById('add-asset-btn');
            const closeModalBtn = document.getElementById('add-asset-modal-close');

            if (addAssetBtn) {
                addAssetBtn.addEventListener('click', () => {
                    addAssetModal.classList.remove('modal-hidden');
                });
            }

            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', () => {
                    addAssetModal.classList.add('modal-hidden');
                });
            }

            if (addAssetModal) {
                addAssetModal.addEventListener('click', (e) => {
                    if (e.target === addAssetModal) {
                        addAssetModal.classList.add('modal-hidden');
                    }
                });
            }

            const addAssetForm = document.getElementById('add-asset-form');
            const editAssetModal = document.getElementById('edit-asset-modal');
            const editAssetClose = document.getElementById('edit-asset-modal-close');
            const editAssetForm = document.getElementById('edit-asset-form');
            const editButton = document.getElementById('edit-asset-btn');
            const saveButton = document.getElementById('save-asset-btn');
            const deleteButton = document.getElementById('delete-asset-btn');

            // Load assets when the page is ready
            loadAssets();

            if (addAssetForm) {
                addAssetForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const formData = new FormData(addAssetForm);
                    const assetData = Object.fromEntries(formData.entries());

                    const companyId = localStorage.getItem('companyId');
                    const username = localStorage.getItem('username');

                    if (!companyId || !username) {
                        alert('Could not find user and company information. Please log in again.');
                        return;
                    }
                    
                    const payload = {
                        name: assetData['asset-name'],
                        type: assetData['asset-type'],
                        description: assetData['asset-description'],
                        classification: assetData['asset-classification'],
                        location: assetData['asset-location'],
                        owner: assetData['asset-owner'],
                        value: assetData['asset-value'],
                        status: assetData['asset-status'],
                        username: username,
                        companyId: parseInt(companyId, 10)
                    };

                    try {
                        const response = await fetch('http://localhost:5000/api/assets', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(payload)
                        });

                        const result = await response.json();

                        if (response.ok && result.success) {
                            alert('Asset created successfully!');
                            addAssetModal.classList.add('modal-hidden');
                            addAssetForm.reset();
                            loadAssets(); // Refresh the asset list
                        } else {
                            alert(`Error: ${result.message}`);
                        }
                    } catch (error) {
                        console.error('Failed to create asset:', error);
                        alert('An error occurred while creating the asset. Please try again.');
                    }
                });
            }

            if (editAssetClose && editAssetModal) {
                editAssetClose.addEventListener('click', () => {
                    closeEditModal();
                });
                editAssetModal.addEventListener('click', (e) => {
                    if (e.target === editAssetModal) closeEditModal();
                });
            }

            if (editButton && editAssetForm && saveButton) {
                editButton.addEventListener('click', () => {
                    setEditMode(false); // turn off readonly
                });
            }

            if (editAssetForm && saveButton) {
                editAssetForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const assetId = document.getElementById('edit-asset-id').value;
                    if (!assetId) return;

                    const payload = {
                        name: document.getElementById('edit-asset-name').value,
                        type: document.getElementById('edit-asset-type').value,
                        description: document.getElementById('edit-asset-description').value,
                        classification: document.getElementById('edit-asset-classification').value,
                        location: document.getElementById('edit-asset-location').value,
                        owner: document.getElementById('edit-asset-owner').value,
                        value: document.getElementById('edit-asset-value').value,
                        status: document.getElementById('edit-asset-status').value
                    };

                    try {
                        const response = await fetch(`http://localhost:5000/api/assets/${assetId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const result = await response.json();
                        if (!response.ok || !result.success) {
                            throw new Error(result.message || 'Failed to update asset');
                        }
                        console.log('Asset updated successfully');
                        setEditMode(true); // back to readonly
                        closeEditModal();
                        loadAssets();
                    } catch (error) {
                        console.error('Failed to update asset:', error);
                        console.error(`Error updating asset: ${error.message}`);
                    }
                });
            }

            if (deleteButton) {
                deleteButton.addEventListener('click', async () => {
                    const assetId = document.getElementById('edit-asset-id').value;
                    if (!assetId) return;
                    const confirmDelete = confirm('Delete this asset from MySQL and MongoDB?');
                    if (!confirmDelete) return;
                    try {
                        const response = await fetch(`http://localhost:5000/api/assets/${assetId}`, {
                            method: 'DELETE'
                        });
                        const result = await response.json();
                        if (!response.ok || !result.success) {
                            throw new Error(result.message || 'Failed to delete asset');
                        }
                        console.log('Asset deleted');
                        closeEditModal();
                        loadAssets();
                    } catch (error) {
                        console.error('Failed to delete asset:', error);
                        alert(`Error deleting asset: ${error.message}`);
                    }
                });
            }
        });

        async function loadAssets() {
            const assetList = document.getElementById('asset-list');
            if (!assetList) return;

            const companyId = localStorage.getItem('companyId');
            if (!companyId) {
                assetList.innerHTML = '<p>Could not determine company. Please log in again.</p>';
                return;
            }

            assetList.innerHTML = '<p>Loading assets...</p>'; // Show a loading message

            const query = `
                query GetAssets($compId: Int!) {
                    assets(comp_id: $compId) {
                        asset_id
                        mongo {
                            name
                            type
                            description
                            classification
                            location
                            owner
                            value
                            status
                        }
                    }
                }
            `;

            const variables = {
                compId: parseInt(companyId, 10)
            };

            try {
                const response = await fetch('http://localhost:4000', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        query,
                        variables 
                    })
                });

                const json = await response.json();

                if(json.errors) {
                    throw new Error(json.errors.map(e => e.message).join('\n'));
                }

                const assets = json.data.assets;

                assetList.innerHTML = ''; // Clear the list

                if (assets && assets.length > 0) {
                    const table = document.createElement('table');
                    table.innerHTML = `
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th>Classification</th>
                                <th>Location</th>
                                <th>Owner</th>
                                <th>Value</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    `;
                    const tbody = table.querySelector('tbody');
                    assets.forEach(asset => {
                        if (asset.mongo) {
                            const row = document.createElement('tr');
                            row.dataset.assetId = asset.asset_id;
                            row.innerHTML = `
                                <td>${asset.asset_id}</td>
                                <td class="asset-link" data-asset-id="${asset.asset_id}">${asset.mongo.name || ''}</td>
                                <td>${asset.mongo.type || ''}</td>
                                <td>${asset.mongo.description || ''}</td>
                                <td>${asset.mongo.classification || ''}</td>
                                <td>${asset.mongo.location || ''}</td>
                                <td>${asset.mongo.owner || ''}</td>
                                <td>${asset.mongo.value || ''}</td>
                                <td>${asset.mongo.status || ''}</td>
                            `;
                            tbody.appendChild(row);
                        }
                    });
                    // Click handler on asset name to open overlay
                    table.addEventListener('click', async (e) => {
                        const target = e.target;
                        if (target && target.classList.contains('asset-link')) {
                            const assetId = target.dataset.assetId;
                            if (assetId) {
                                await openEditModal(assetId);
                            }
                        }
                    });
                    assetList.appendChild(table);
                } else {
                    assetList.innerHTML = '<p>No assets found for your company.</p>';
                }
            } catch (error) {
                console.error('Failed to fetch assets:', error);
                assetList.innerHTML = `<p>Error loading assets: ${error.message}</p>`;
            }
        }

        function setEditMode(readonly = true) {
            const form = document.getElementById('edit-asset-form');
            const saveButton = document.getElementById('save-asset-btn');
            const editButton = document.getElementById('edit-asset-btn');
            if (!form || !saveButton || !editButton) return;
            if (readonly) {
                form.classList.add('readonly-mode');
                saveButton.style.display = 'none';
                editButton.style.display = 'inline-flex';
            } else {
                form.classList.remove('readonly-mode');
                saveButton.style.display = 'inline-flex';
                editButton.style.display = 'none';
            }
        }

        function closeEditModal() {
            const modal = document.getElementById('edit-asset-modal');
            if (modal) modal.classList.add('modal-hidden');
            setEditMode(true);
        }

        async function openEditModal(assetId) {
            try {
                const response = await fetch(`http://localhost:5000/api/assets/${assetId}`);
                const result = await response.json();
                if (!response.ok || !result.success) {
                    throw new Error(result.message || 'Failed to load asset');
                }
                const asset = result.asset;
                document.getElementById('edit-asset-id').value = asset.asset_id;
                document.getElementById('edit-asset-name').value = asset.name || '';
                document.getElementById('edit-asset-type').value = asset.type || 'Server';
                document.getElementById('edit-asset-description').value = asset.description || '';
                document.getElementById('edit-asset-classification').value = asset.classification || 'public';
                document.getElementById('edit-asset-location').value = asset.location || '';
                document.getElementById('edit-asset-owner').value = asset.owner || '';
                document.getElementById('edit-asset-value').value = asset.value || 'low';
                document.getElementById('edit-asset-status').value = asset.status || 'active';
                setEditMode(true);
                const modal = document.getElementById('edit-asset-modal');
                if (modal) modal.classList.remove('modal-hidden');
            } catch (error) {
                console.error('Failed to open asset modal:', error);
                alert(`Could not load asset: ${error.message}`);
            }
        }
    </script>
</body>
</html>