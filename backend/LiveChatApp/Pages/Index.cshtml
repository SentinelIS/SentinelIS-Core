@page
@model IndexModel
@{
    ViewData["Title"] = "Live Chat";
}

<div class="chat-container">
    <div class="chat-header">
        <h1>Live Chat</h1>
        <div class="form-group">
            <label for="userInput">Benutzername:</label>
            <input type="text" id="userInput" class="form-control" placeholder="Dein Name" />
        </div>
    </div>

    <ul id="messagesList" class="chat-messages"></ul>

    <div class="chat-input-form">
        <div class="input-group">
            <input type="text" id="messageInput" class="form-control" placeholder="Schreibe etwas..." />
            <div class="input-group-append">
                <button id="sendButton" class="btn btn-primary">Senden</button>
            </div>
        </div>
    </div>
</div>

<!-- SignalR Client -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>

<script>
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/chathub")
        .withAutomaticReconnect()
        .build();

    let currentUser = "Anonym";

    connection.on("ReceiveMessage", function (user, message) {
        const li = document.createElement("li");
        li.classList.add("message");

        const messageUser = document.getElementById("userInput").value || "Anonym";

        if (user === messageUser) {
            li.classList.add("sent");
        } else {
            li.classList.add("received");
        }

        const strong = document.createElement("strong");
        strong.textContent = user;
        
        const messageText = document.createElement("p");
        messageText.textContent = message;

        li.appendChild(strong);
        li.appendChild(messageText);

        const messagesList = document.getElementById("messagesList");
        messagesList.appendChild(li);
        messagesList.scrollTop = messagesList.scrollHeight;
    });

    async function start() {
        try {
            await connection.start();
            console.log("SignalR verbunden");
        } catch (err) {
            console.error(err);
            setTimeout(start, 2000);
        }
    }

    document.getElementById("sendButton").addEventListener("click", async function () {
        const user = document.getElementById("userInput").value || "Anonym";
        currentUser = user;
        const message = document.getElementById("messageInput").value;

        if (!message) return;

        await connection.invoke("SendMessage", user, message);
        document.getElementById("messageInput").value = "";
    });

    document.getElementById("messageInput").addEventListener("keyup", function (event) {
        if (event.key === "Enter") {
            document.getElementById("sendButton").click();
        }
    });

    start();
</script>
